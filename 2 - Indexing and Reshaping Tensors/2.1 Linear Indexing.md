## 2.1 Linear Indexing  

For a 3-way tensor $\textbf{X} \in \mathbb{R}^{m \times n \times p}$ , every entry is identified by a 3-tuple of the form $(i,j,k) \in [m] \otimes [n] \otimes [p]$. Another common convention is **linear indexing**, where each entry is mapped to a single index $l \in [mnp]$.

<br>

For a tensor of size $2 \times 2 \times 2$, there are $8!$ possible bijections between tensor entries and linear positions, but most of these mappings are not practically useful. Instead, we restrict attention to mappings that keep fibers and slices contiguous in memory. For such contiguous storage orders, the linearization is defined *via* mode strides, so that the mapping from $(i,j,k)$ to a linear index $l$ has the form
```math
l = 1 + s_1(i-1) + s_2(j-1) + s_3(k-1)
```
So for the previous tensor, we reduce the number of possibilities to only $3!$ since we can permute $(i,j,k)$ in 6 different ways.
<br>
On those 6 differents ways, we have 3 distinct ordering: <br>
- **Natural Ordering**: Having the shortest stride in mode 1, the next shortest in mode 2, *etc* (\*)
- **Reverse Ordering**: Having the longest stride in mode 1, the next longest in mode 2, and so on.
- **General Orderings**: Other ordering that keeps different fibers and slices in order.

<br>

(\*) In other words, we simply increment $i$ before $j$ and before $k$.  
$(1,1,1), (2,1,1), (1,2,1), (2,2,1), (1,1,2), (2,1,2), (1,2,2), (2,2,2)$

<br>
<br>

### 2.1.1 Natural Order Linear Indexing

For 3-way Tensors of size $m \times n \times p$, the **natural order** can be seen as the shortest strides to mode-1 fibers, the next smallest to the mode-2 fibers and the longest to the mode-3 fibers.
<br>

```math
s_1 = 1, s_2 = m, s_3 = mn
```

<br>

Or be given by: $\mathbb{L}(i,j,k) = 1 + s_1(i - 1) + s_2(j - 1) + s_3(k - 1) = i + m(j - 1) + mn(k - 1)$

The **tuple index** $(i,j,k)$ can be computed from $l \in [mnp] as (i,j,k) = \mathbb{T}(l)$, where
<br>
$i = \mathbb{T}_1(l) = 1 + \lfloor ((l - 1) \pmod{ms_1})/s_1\rfloor = 1 + (l - 1) \pmod{m}$, <br>
$j = \mathbb{T}_2(l) = 1 + \lfloor ((l - 1) \pmod{ns_2})/s_2\rfloor = 1 + \lfloor ((l - 1) \pmod{nm})/m\rfloor$, <br>
$k = \mathbb{T}_3(l) = 1 + \lfloor ((l - 1) \pmod{ps_3})/s_3\rfloor = 1 + \lfloor (l - 1)/mn\rfloor$, <br>

*(Same formulas but better representation)* <br>
$i = \mathbb{T}_1(l)
  = 1 + \left\lfloor \dfrac{(l - 1) \bmod (m s_1)}{s_1} \right\rfloor
  = 1 + (l - 1) \bmod m,$

$j = \mathbb{T}_2(l)
  = 1 + \left\lfloor \dfrac{(l - 1) \bmod (n s_2)}{s_2} \right\rfloor
  = 1 + \left\lfloor \dfrac{(l - 1) \bmod (n m)}{m} \right\rfloor,$

$k = \mathbb{T}_3(l)
  = 1 + \left\lfloor \dfrac{(l - 1) \bmod (p s_3)}{s_3} \right\rfloor
  = 1 + \left\lfloor \dfrac{l - 1}{m n} \right\rfloor.$

<br>

In this work, we store a 3-way tensor $X \in \mathbb{R}^{m \times n \times p}$ contiguously in memory using a single linear index $l$. The multi-index $(i,j,k)$ refers to the entry $X(i,j,k)$ in tensor form, while $l$ denotes the corresponding position of this entry in the underlying one-dimensional storage. The mapping between these two representations is defined by a linearization function based on mode strides, so that $l$ can be computed from $(i,j,k)$, and conversely $(i,j,k)$ can be recovered from any valid linear index $l$.

<br>

> **Definition (Linear/Tuple Index Conversion for Natural Ordering)**  
> The **strides** for the **natural ordering** are <br>
> $s_1 = 1$ and $s_{k+1} = \prod_{\alpha=1}^{k} n_{\alpha} = s_kn_k$ for $k \in [d - 1]$.  <br>
> The **linear index** of the tuple $(i_1, i_2, \dots , i_d) \in [n_1] \otimes [n_2] \otimes \dots \otimes [n_d]$ is <br>
> $\alpha = \mathbb{L}(i_1, i_2, \dots , i_d) = 1 + \sum_{k=1}^d s_k(i_k - 1)$.  <br>
> The **tuple index** of $\alpha \in [\mathbb{N}]$ with $\mathbb{N} = \prod_{k=1}^d n_k$ is $(i_1, i_2, \dots , i_d) = \mathbb{T}(\alpha)$, where <br>
> $i_k =\mathbb{T}_k(i) = 1 + \left \lfloor \dfrac{((\alpha - 1) \bmod (n_ks_k))}{s_k} \right\rfloor$.

<br>

> **Proposition (Composition of Linearization)**
>  /to complete

<br> <br>

### 2.1.2 Reverse Ordering Linear Indexing

That is basically the invert of what we saw previously. Instead of having the shortest strides in $1^{st}$, we'll have the longest, then the $2^{nd}$ longest and finally the shortest for the last one.
<br>
In a tensor of size $m \times n \times p$, the strides are

$s_1^* = np$, $s_2^* = p$ and $s_3^* = 1$

So the linear index can be computed as $\mathbf{L}^{\*}(i,j,k) = 1 + s_1^{\*}(i - 1) + s_2^*(j - 1) + s_3^{\*}(k - 1) = np(i - 1) + p(j - 1) + k$.

And like before, we can found the tuple $(i,j,k)$ from $l \in [mnp]$:
```math
\begin{aligned}
i = \mathbb{T}_1^{*}(l) = 1 + \left\lfloor \dfrac{(l - 1) \bmod (m s_1^{*})}{s_1^{*}} \right\rfloor = 1 + \left\lfloor\dfrac{(l - 1)}{n p} \right\rfloor,
\\[8pt]
j = \mathbb{T}_2^{*}(l) = 1 + \left\lfloor \dfrac{(l - 1) \bmod (n s_2^{*})}{s_2^{*}} \right\rfloor = 1 + \left\lfloor \dfrac{(l - 1) \bmod (n p)}{p} \right\rfloor,
\\[8pt]
k = \mathbb{T}_3^{*}(l) = 1 + \left\lfloor \dfrac{(l - 1) \bmod (p s_3^{*})}{s_3^{*}} \right\rfloor = 1 + (l - 1) \bmod p.
\end{aligned}
```

<br>

I finally understand what the $\otimes$ means, it's the **Kronecker product**, and it's calculated by replicate a B struct to a general A struct:  
Let's take 2 examples  
```math
\begin{aligned}
A = 
\begin{bmatrix}
1 & 2 \\ 3 & 4 \end{bmatrix}, \quad
B = 
\begin{bmatrix}
0 & 5 \\ 6 & 7
\end{bmatrix}
\end{aligned}
```
The Kronecker product of $A \otimes B$ is:
```math
A \otimes B = \begin{bmatrix} 1B & 2B \\ 3B & 4B \end{bmatrix} = \quad \begin{bmatrix} 0 & 5 & 0 & 10 \\ 6 & 7 & 12 & 14 \\ 0 & 15 & 0 & 20 \\ 18 & 21 & 24 & 28 \end{bmatrix} 
```


<br>
<br>










## Exercises

> **Exercise 2.1** <br>
> List the strides $s_1, s_2 and s_3$ for each of the 6 orderings in Figure 1.

> **Figure 1**

```math
      \begin{aligned}
      a(:,:,1) = \begin{bmatrix} 1 & 3 \\ 2 & 4\end{bmatrix}, \quad a(:,:,2) = \begin{bmatrix} 5 & 7 \\ 6 & 8\end{bmatrix}  
      \\[8pt]
      a) Natural Ordering
\\[16pt]
\\[16pt]
      b(:,:,1) = \begin{bmatrix} 1 & 5 \\ 2 & 6\end{bmatrix}, \quad b(:,:,2) = \begin{bmatrix} 3 & 7 \\ 4 & 8\end{bmatrix}  
      \\[8pt]
      b) General Ordering
      \\[16pt]
\\[16pt]
      c(:,:,1) = \begin{bmatrix} 1 & 2 \\ 3 & 4\end{bmatrix}, \quad c(:,:,2) = \begin{bmatrix} 5 & 6 \\ 7 & 8\end{bmatrix}  
      \\[8pt]
      c) General Ordering
\\[16pt]
\\[16pt]
      d(:,:,1) = \begin{bmatrix} 1 & 5 \\ 3 & 7\end{bmatrix}, \quad d(:,:,2) = \begin{bmatrix} 2 & 6 \\ 4 & 8\end{bmatrix}  
      \\[8pt]
      d) General Ordering
\\[16pt]
\\[16pt]
      e(:,:,1) = \begin{bmatrix} 1 & 2 \\ 5 & 6\end{bmatrix}, \quad e(:,:,2) = \begin{bmatrix} 3 & 4 \\ 7 & 8\end{bmatrix}  
      \\[8pt]
      e) General Ordering
\\[16pt]
\\[16pt]
      f(:,:,1) = \begin{bmatrix} 1 & 3 \\ 5 & 7\end{bmatrix}, \quad f(:,:,2) = \begin{bmatrix} 2 & 4 \\ 6 & 8\end{bmatrix}  
      \\[8pt]
      f) Reverse Ordering
      
      
      \end{aligned}
```

### Solution - Exercise 2.1

**a)**
```math
\begin{aligned}
1 = (1,1,1) , 2 = (2,1,1), 3 = (1,2,1), 4 = (2,2,1), 5 = (1,1,2), 6 = (2,1,2), 7 = (1,2,2), 8 = (2,2,2)       \\[8pt]

(1,1,1) → (2,1,1) : 1 → 2  : s_1 = 2 - 1 = 1        \\[8pt]

(1,1,1) → (1,2,1) : 1 → 3 : s_2 = 3 - 1 = 2       \\[8pt]

(1,1,1) → (1,1,2) : 1 → 5 : s_3 = 5 - 1 = 4
\end{aligned}
```

**b)**
```math
\begin{aligned}

1 = (1,1,1) , 2 = (2,1,1), 5 = (1,2,1), 7 = (2,2,1), 3 = (1,1,2), 7 = (2,1,2), 4 = (1,2,2), 8 = (2,2,2)       \\[8pt]

(1,1,1) → (2,1,1) : 1 → 2  : s_1 = 2 - 1 = 1        \\[8pt]

(1,1,1) → (1,2,1) : 1 → 5 : s_2 = 5 - 1 = 4       \\[8pt]

(1,1,1) → (1,1,2) : 1 → 3 : s_3 = 3 - 1 = 2
\end{aligned}

```

**c)**
```math
\begin{aligned}

1 = (1,1,1) , 3 = (2,1,1), 2 = (1,2,1), 4 = (2,2,1), 5 = (1,1,2), 7 = (2,1,2), 6 = (1,2,2), 8 = (2,2,2)       \\[8pt]

(1,1,1) → (2,1,1) : 1 → 3  : s_1 = 3 - 1 = 2        \\[8pt]

(1,1,1) → (1,2,1) : 1 → 2 : s_2 = 2 - 1 = 1       \\[8pt]

(1,1,1) → (1,1,2) : 1 → 5 : s_3 = 5 - 1 = 4
\end{aligned}

```

**d)**
```math
\begin{aligned}

1 = (1,1,1) , 3 = (2,1,1), 5 = (1,2,1), 7 = (2,2,1), 2 = (1,1,2), 4 = (2,1,2), 6 = (1,2,2), 8 = (2,2,2)       \\[8pt]

(1,1,1) → (2,1,1) : 1 → 3  : s_1 = 3 - 1 = 2       \\[8pt]

(1,1,1) → (1,2,1) : 1 → 5 : s_2 = 5 - 1 = 4       \\[8pt]

(1,1,1) → (1,1,2) : 1 → 2 : s_3 = 2 - 1 = 1
\end{aligned}

```

**e)**
```math
\begin{aligned}

1 = (1,1,1) , 5 = (2,1,1), 2 = (1,2,1), 6 = (2,2,1), 3 = (1,1,2), 7 = (2,1,2), 4 = (1,2,2), 8 = (2,2,2)       \\[8pt]

(1,1,1) → (2,1,1) : 1 → 5  : s_1 = 5 - 1 = 4       \\[8pt]

(1,1,1) → (1,2,1) : 1 → 2 : s_2 = 2 - 1 = 1       \\[8pt]

(1,1,1) → (1,1,2) : 1 → 3 : s_3 = 3 - 1 = 2
\end{aligned}

```

**f)**
```math
\begin{aligned}

1 = (1,1,1) , 5 = (2,1,1), 3 = (1,2,1), 7 = (2,2,1), 2 = (1,1,2), 6 = (2,1,2), 4 = (1,2,2), 8 = (2,2,2)       \\[8pt]

(1,1,1) → (2,1,1) : 1 → 5  : s_1 = 5 - 1 = 4      \\[8pt]

(1,1,1) → (1,2,1) : 1 → 3 : s_2 = 3 - 1 = 2      \\[8pt]

(1,1,1) → (1,1,2) : 1 → 2 : s_3 = 2 - 1 = 1
\end{aligned}

```
<br> <br>

> **Exercise 2.2** <br>
> For a tensor of size $4 \times 3 \times 3$, list the linear indices of the following tuple indices:  
> a) (3,2,3) <br>
> b) (4,3,1) <br>
> c) (2,2,2) <br>
> List the tuple indices for the following linear indices: <br>
> d) 16 <br>
> e) 7 <br>
> f) 33 <br>

### Solutions - Exercise 2.2

**a)**

We have $m = 4, n = 3 and p = 3$. With the formula $i + m(j - 1) + mn(k - 1)$, we find $3 + 4(2 - 1) + 4 \times 3 (3 - 1) = 31$.  


**b)**

We find $4 + 4(3 - 1) + 12(1 - 1) = 12$.  


**c)**

We find $2 + 4(2 - 1) + 12(2 - 1) = 18$.  


**d)**

We have $l = 16$. So, with the formula, <br> 
$i = 1 + (16 - 1) \bmod{4} = 4$ <br> 
$j = 1 + \left\lfloor \dfrac{(16 - 1) \bmod 12}{4} \right\rfloor = 1$ <br>
$k = 1 + \left\lfloor \dfrac{(16 - 1)}{12} \right\rfloor= 2$ <br>
So the tuple is $(4,1,2)$.


**e)**

We have $l = 7$, <br>
$i = 1 + (7 - 1) \bmod{4} = 3$ <br> 
$j = 1 + \left\lfloor \dfrac{(7 - 1) \bmod 12}{4} \right\rfloor = 2$ <br>
$k = 1 + \left\lfloor \dfrac{(7 - 1)}{12} \right\rfloor = 1$ <br>
So the tuple is $(3,2,1)$.


**f)**

We have $l = 33$, <br>
$i = 1 + (33 - 1) \bmod{4} = 1$ <br> 
$j = 1 + \left\lfloor \dfrac{(33 - 1) \bmod 12}{4} \right\rfloor = 3$ <br>
$k = 1 + \left\lfloor \dfrac{(33 - 1)}{12} \right\rfloor = 3$ <br>
So the tuple is $(1,3,3)$.

<br> <br>

> **Exercise 2.3** <br>
> For a tensor of size $100 \times 80 \times 60$, list the linear indices of the following tuple indices: <br>
> a) $(70,26,58)$ <br>
> b) $(4,36,23)$ <br>
> c) $(77,64,12)$ <br>
> List the tuple indices for the following linear indices: <br>
> d) 235,087 <br>
> e) 213,882 <br>
> f) 310,231 <br>

###Solutions - Exercise 2.3

**a)**

We have $m = 100, n = 80 and p = 60$. With the formula $i + m(j - 1) + mn(k - 1)$, we find $70 + 100(26 - 1) + 100 \times 80 (58 - 1) = 458,570$. 


**b)**

We find $4 + 100(36 - 1) + 8000(23 - 1) = 179,504$.


**c)**

We find $77 + 100(64 - 1) + 8000(12 - 1) = 94,377$.



**d)**

We have $l = 235,087$. So, with the formula, <br> 
$i = 1 + (235,087 - 1) \bmod{100} = 87$ <br> 
$j = 1 + \left\lfloor \dfrac{(235,087 - 1) \bmod 8000}{100} \right\rfloor = 31$ <br>
$k = 1 + \left\lfloor \dfrac{(235,087 - 1)}{8000} \right\rfloor= 30$ <br>
So the tuple is $(87,31,30)$.

**e)**

We have $l = 213,882$. So, with the formula, <br> 
$i = 1 + (213,882 - 1) \bmod{100} = 82$ <br> 
$j = 1 + \left\lfloor \dfrac{(213,882 - 1) \bmod 8000}{100} \right\rfloor = 59$ <br>
$k = 1 + \left\lfloor \dfrac{(213,882 - 1)}{8000} \right\rfloor= 27$ <br>
So the tuple is $(82,59,27)$.


**f)**

We have $l = 310,231$. So, with the formula, <br> 
$i = 1 + (310,231 - 1) \bmod{100} = 31$ <br> 
$j = 1 + \left\lfloor \dfrac{(310,231 - 1) \bmod 8000}{100} \right\rfloor = 63$ <br>
$k = 1 + \left\lfloor \dfrac{(310,231 - 1)}{8000} \right\rfloor= 39$ <br>
So the tuple is $(31,63,39)$.

<br> <br>

> **Exercise 2.4** <br>
> Prove that if $l = \mathbb{L}(i,(\mathbb{L}(j,k;n,p);m,np)$, then $l = \mathbb{L}(i,j,k;m,n,p)$.

### Solution - Exercise 2.4

No idea yet

<br> <br>

> **Exercise 2.5** <br>
> For a tensor of size $5 \times 4 \times 3 \times 4$, what are the strides $(s_1, s_2, s_3, s_4)$ for the natural ordering?

### Solution - Exercise 2.5

With $(n_1, n_2, n_3, n_4) = (5, 4, 3, 4)$: <br>
$s_1 = 1$, $s_2 = s_1n_1 = 1 \times 5 = 5$, $s_3 = s_2n_2 = 5 \times 4 = 20$ and $s_4 = s_3n_3 = 20 \times 3 = 60$ 


<br>
<br>

> **Exercise 2.6** <br>
> Write genral *d*-way functions *lin2tup* and *tup2lin* to convert between linear and tuple indices and *vice versa*.

### Solution - Exercise 2.6
```python
function lin2tup(alpha, n[1..d]):
    s[1] = 1
    for k = 1 to d-1:  // the strides calculation (like exercise 2.5)
        s[k+1] = s[k] * n[k]

    for k = 1 to d:  // application of the formula (tuple index)
        i[k] = 1 + floor( ((alpha - 1) mod (n[k] * s[k])) / s[k] )

    return i[1..d]


function tup2lin(i[1..d], n[1..d]):
    s[1] = 1
    for k = 1 to d-1:  //same as before, strides calculation
        s[k+1] = s[k] * n[k]

    alpha = 1
    for k = 1 to d: // application of the linear index formula
        alpha = alpha + s[k] * (i[k] - 1)

    return alpha

```

<br> <br>

> **Exercise 2.8** <br>
> Let $l = \mathbb{L}^*(i,j,k;m,n,p)$. <br>
> Show $l = \mathbb{L}(k,j,i;p,n,m)$.

### Solution - Exercise 2.8

We have

$\mathbb{L}^*(i,j,k;m,n,p) = 1 + np(i-1) + p(j-1) + (k-1)$, and $\mathbb{L}(k,j,i;p,n,m) = 1 + pn(i-1) + p(j-1) + (k-1) = 1 + np(i-1) + p(j-1) + (k-1)$.

Hence $\mathbb{L}^*(i,j,k;m,n,p) = \mathbb{L}(k,j,i;p,n,m)$, as required.



